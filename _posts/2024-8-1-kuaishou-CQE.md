---
layout: post
title: kuaishou CQE时长预估介绍
description: 
modified: 2024-8-1
tags: 
---

kuaishou在《Conditional Quantile Estimation for Uncertain Watch Time in
Short-Video Recommendation》提出了CQE预估模型。

# 摘要

准确预测观看时间(watch time)对于优化短视频平台的推荐和用户体验至关重要。然而，现有方法通常估计**单一的平均观看时间（average watch time）**，往往无法捕捉用户参与模式固有的不确定性和多样性。在本文中，我们提出了条件分位数估计（Conditional Quantile Estimation, CQE）框架来模拟观看时间的全部条件分布。利用分位数回归，CQE为每对用户-视频对表征复杂的观看时间分布，提供了一种灵活全面的了解用户行为的方法。我们进一步设计了多种策略来结合分位数估计，以适应不同的推荐场景和用户偏好。大量的离线实验和在线A/B测试证明了CQE在观看时间预测和用户参与建模方面的优越性。特别是，CQE在一个服务数亿日活跃用户的短视频平台上的在线部署，已经产生了关键评估指标的显著改进，包括活跃天数、活跃用户数、参与持续时间和视频观看次数。这些结果突出了我们提出的方法在增强用户体验和短视频推荐系统整体性能方面的实际影响。代码将在发表后发布。

# 1 引言

在线视频平台的快速增长彻底改变了用户消费数字内容的方式，短视频已成为最受欢迎的格式之一[3, 9, 10, 23]。推荐系统在这些平台中扮演着至关重要的角色，通过提供个性化的内容推荐来增强用户参与度和满意度。与传统的推荐问题（例如，电子商务和新闻推荐）不同，在短视频推荐中，衡量用户兴趣和参与度的关键指标是观看时间，它全面反映了用户的偏好和参与度。因此，准确预测观看时间对于优化推荐策略和改善用户体验至关重要。

然而，由于**用户行为固有的不确定性和异质性**，预测观看时间仍然是一个具有挑战性的任务。在现实世界场景中，通常不可能在相同条件下获得同一用户-视频对的多次观看时间观察，**因为用户很少在完全相同的情境下多次观看同一视频**。这一限制使我们无法直接从数据中估计真实的条件观看时间分布。

现有方法[16, 20–22]通常专注于**预测观看时间的单点估计（例如，均值或中位数）**，忽视了观看时间分布的复杂性和多样性。这些方法未能充分捕捉不同用户-视频对之间的行为差异，导致推荐性能受限。使用单一平均值来表征这些复杂分布模式的不足强调了需要对观看时间的全部条件分布进行建模的必要性。

<img alt="图片名称" src="https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/f895a0e5481d8cfa0bbf7a9b4bd7cf0d2d779cd9d80f27fd76478b93200b59d4fdff63f5ea1a941fdde8f89f369c4f5d?pictype=scale&amp;from=30113&amp;version=3.3.3.3&amp;fname=1.jpg&amp;size=750">

图1 条件观看时间分布和一些个性化推荐策略的示意图。

- 图(a) CQE模型为不同的用户-视频对预测的条件观看时间分布，展示了用户参与模式的异质性和复杂性。
- 图(b) 保守估计策略在预期观看时间相似时优先选择具有较高下分位数的视频，以提高用户满意度。
- 图(c) 动态分位数组合策略适应用户流失风险和视频新颖性，对高流失风险用户或不熟悉的视频使用较低分位数，对低流失风险用户或熟悉的视频使用较高分位数。
- 图(d) 期望估计策略通过考虑整个观看时间分布，提供全局优化视角。

为了应对这些挑战，我们提出了条件分位数估计（Conditional Quantile Estimation, CQE）框架，该框架学习预测给定用户-视频对及其相关上下文的观看时间的条件分布。如图2所示，CQE利用分位数回归技术估计观看时间分布的多个分位数，提供了一个全面了解潜在用户参与模式的视角。如图1(a)所示，我们的CQE模型预测的不同用户-视频对的条件观看时间分布，在形状、峰值位置和离散水平上表现出显著的多样性。这种异质性反映了用户偏好和参与在不同情境下固有的不确定性和可变性。

<img alt="图片名称" src="https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/dfa943a941ec0e616bf1439b6c08c8a390992622b547c5c74d1654c6e46d53e278dd203d31a33f620ca2b90a3d3a2b0a?pictype=scale&amp;from=30113&amp;version=3.3.3.3&amp;fname=2.jpg&amp;size=750">

图2 提出的条件分位数估计（CQE）模型及其训练损失的示意图。

- 图2左侧：CQE模型架构，它以用户、视频和上下文特征为输入，并输出观看时间的多个分位数估计。
- 图2右侧：用于模型训练的PinBall loss函数，展示了其对于不同分位数水平（$\tau$）的不对称性质，允许模型在整个分布中学习到稳健的分位数估计。

建模观看时间的条件分布对于理解用户参与模式和设计有效的推荐策略至关重要。**通过考虑观看时间分布的详细特征，我们可以深入了解不同用户群体的多样化观看行为**。这种细粒度的理解使我们能够为不同情境和用户偏好量身定制推荐策略。

基于CQE模型，我们设计了三种主要的推荐策略。

- 保守估计策略（图1(b)）：通过在预期观看时间相似时选择具有较高下分位数的视频，优先考虑用户满意度，减少用户参与度下降的风险。
- 动态分位数组合策略（图1(c)）：根据用户流失风险和视频新颖性等因素调整分位数的选择。对于高流失风险用户或新颖视频，它更多地赋予低分位数权重，确保令人满意的体验，对于低流失风险用户或熟悉视频，则更多地赋予高分位数权重，可能提供更具吸引力的推荐。
- 期望估计策略（图1(d)）：提供了一个全局优化视角，旨在考虑整个观看时间分布，最大化整体用户参与度。这些策略的多样性使我们的推荐系统能够适应不同的场景和用户需求，提高个性化推荐和用户体验的质量。

本文的主要贡献如下：

- 我们提出了CQE框架，采用分位数回归技术模拟短视频推荐中观看时间的条件分布，为捕捉用户行为的不确定性提供了一种有原则的方法。
- 我们设计了多种策略来结合CQE的分位数估计，适应不同的推荐场景和用户偏好，增强了推荐系统的个性化和多样性。
- 我们进行了广泛的离线实验和在线A/B测试，证明了CQE在观看时间预测和用户参与建模方面的优越性，显著提升了关键评估指标，包括活跃天数、活跃用户数、参与持续时间和视频观看次数。

# 2 相关工作

## 2.1 视频推荐和观看时间预测

视频推荐系统已经发展到满足个性化内容传递的日益增长的需求。随着YouTube和TikTok等在线视频平台的出现，准确推荐视频非常重要，因为它对用户留存和满意度有着重大影响[3, 9, 10, 16, 23]。
在视频推荐系统的领域中，准确预估在**观看时间上的用户参与度**是一个关键挑战。观看时间作为衡量用户对推荐视频兴趣和参与度的关键指标。

- 最初的研究[2]集中在增强YouTube平台的视频推荐，引入了**加权逻辑回归（WLR）技术**来预测观看时间。这种方法自此被认为是该领域的先进方法。然而，WLR的适用性并不直接适用于全屏视频推荐系统，并且可能会遇到由于其加权计算系统而产生的显著偏差问题。
- D2Q[20]通过实施后门调整和在不同持续时间组下建模观看时间分位数来减轻持续时间偏差。
- $D^2Co$[21]通过使用纠正持续时间偏差和嘈杂观看的模型来解决视频推荐观看时间的偏差问题，提供更准确的用户兴趣度量。
- DVR[22]引入了一种称为WTG（观看时间增益）的新指标，并使用对抗学习来学习无偏的用户偏好。我们的方法可以无缝集成到各种持续时间去偏差方法中，从而显著提高它们的预测准确性。
- TPM[8]将任务分解成一系列以树状结构排列的相互连接的分类问题。尽管TPM考虑了观看时间的变异性，但它没有像我们的方法那样捕捉到观看时间分布的全部范围。

观看时间预测任务还面临**物理时长偏差（duration bias）**的关键问题[8, 20–22]。这种偏差表明，用户更愿意花更多时间观看更长物理时间的视频（longer-duration videos），这使得平均观看时间偏向更长的内容。这种偏好使得在预测用户参与度时，比起更短的替代品，更复杂的任务变得更加复杂。我们的方法可以无缝集成到大多数持续时间去偏差方法中，显著提高它们的预测能力，如表3所示。

表3

## 2.2 分位数回归

分位数回归是一种在统计学、计量经济学和生态学中广泛使用的回归分析类型[7]。与传统的均值/线性回归（专注于估计平均结果）不同，分位数回归旨在估计随机变量的条件中位数和其他分位数。这一灵活的特性提供了对变量分布效应的更全面理解，这些效应可能是均值回归可能忽视的[1, 18, 19]。在机器学习的背景下，分位数回归已经超越了线性模型。代表性方法[13, 14, 17]将分位数回归整合到神经网络中，提供了在非线性和高维环境中预测条件分位数的手段。QRF[11]进一步在随机森林中部署分位数回归，进一步展示了其适应性和在不同模型中增强预测能力。

本文提出的解决方案旨在将分位数回归的原则整合到视频推荐系统的领域。通过使这种统计方法适应观看时间的不确定性和可变性，我们提出了一种新颖的应用，增强了推荐系统的预测性能。这一进步促进了对用户参与度的更细致的理解，朝着更个性化和令人满意的用户体验发展。

# 3 方法

## 3.1 问题阐述

在视频推荐系统中，我们的主要目标是预测用户参与度，通常以观看时间来衡量。设：

- $(u, v)$ 表示在上下文 $ c $ 下的一对用户-视频。
- $ \phi(u, v, c) $，定义一个特征映射函数，它提取一个 $ n $ 维特征向量 $ x \in \mathbb{R}^n $。这个向量包含了用户特征、视频属性、上下文信息和历史交互数据。
- $ W $ 为表示观看时间的随机变量。

我们的目标是：估计给定输入特征的 $ W $ 的概率分布：

$$
P(W | x) = P(W | \phi(u, v, c))
$$

...(1)

与传统方法[2, 16, 20–22]不同，这些方法专注于估计单一的点（例如，期望观看时间 $ E[W \mid x] $），我们的目标是表征整个条件分布。这使我们能够捕捉用户参与模式固有的不确定性和可变性，提供对潜在用户行为更全面的理解。

## 3.2 条件分位数估计模型

为了捕捉观看时间的全部分布，我们提出了条件分位数估计（Conditional Quantile Estimation, CQE）模型。如图2的左半部分所示，这种方法允许我们同时估计观看时间分布的多个分位数，提供对潜在用户参与的更全面视图。

设：

- $ \{\tau_1, \tau_2, ..., \tau_N\} $ 是一组预先定义的 $ N $ 个分位数水平，其中 $ \tau_i = \frac{i}{N+1} $。

我们的CQE模型旨在估计给定输入特征 $ x $ 的每个分位数水平对应的观看时间值 $ \{t_{\tau_1}, t_{\tau_2}, ..., t_{\tau_N}\} $：

$$
\{t_{\tau_1}, t_{\tau_2}, ..., t_{\tau_N}\} = \psi(x; \theta)
$$

...(2)

其中：

- $ \psi(\cdot) $ 是一个由 $ \theta $ 参数化的神经网络。

为确保分位数估计的单调性，我们实现了以下架构：

$$
h = f(x; \theta_f) \\
d = \text{ReLU}(g(h; \theta_g)) \\
t_{\tau_i} = \sum_{j=1}^{i} d_j, \quad \text{对于} \ i = 1, ..., N 
$$

...（3）

这里：

- $ f(\cdot) $ 和 $ g(\cdot) $ 是神经网络组件，
- $ h $ 是中间隐藏表示，
- $ d $ 是一个非负元素向量。

最终的分位数估计 $ t_{\tau_i} $ 通过累积求和获得，自然地强制执行排序约束： $ t_{\tau_1} \leq t_{\tau_2} \leq ... \leq t_{\tau_N} $。

这种公式允许我们的模型捕捉输入特征和观看时间分位数之间的复杂非线性关系，同时保持分位数函数的必要单调性属性。

为了清晰概述我们的CQE方法，我们在算法1中展示了算法伪代码。

算法1

CQE模型的计算复杂度与传统的点估计方法相当，仅因估计多个分位数而略有增加。在大规模推荐系统中，独特用户和项目的数量经常达到数亿甚至数十亿。这些用户和项目通常由高维嵌入表示，这些嵌入使用它们各自的ID检索。相比之下，有效估计所需的分位数数量通常在100左右。因此，CQE的额外计算成本与处理大量特征所需的大量计算相比可以忽略不计。

## 3.3 训练目标

为了有效地训练我们的CQE模型，我们采用了适合分位数回归任务的钉球损失函数。对于单一分位数水平 $ \tau $，钉球损失定义为：

$$
L_\tau(y, t_\tau) = 
  \begin{cases} 
  \tau (y - t_\tau) & \text{if } y \geq t_\tau \\
  (1 - \tau) (t_\tau - y) & \text{otherwise}
  \end{cases}
$$

...(4)

其中：

- $ y $ 是实际观看时间
- $ t_\tau $ 是预测的第 $ \tau $ 个分位数。

正如图2的右半部分所示，钉球损失函数具有几个关键属性：

- 不对称性：损失围绕真实值 $ y $ 是不对称的，不对称的程度由 $ \tau $ 决定。
- 线性：损失随着预测值和实际值之间的距离线性增加，但在 $ y $ 的两侧斜率不同。
- 分位数特定的惩罚：对于 $ \tau > 0.5 $，过高估计比过低估计受到更重的惩罚，反之亦然 $ \tau < 0.5 $。

这些属性使得钉球损失特别适合分位数估计。对于我们的多分位数模型，我们聚合了所有分位数水平上的钉球损失：

$$
L_{QR} = \sum_{i=1}^{N} L_{\tau_i}(y, t_{\tau_i})
$$

...(5)

这个聚合的损失函数鼓励模型在整个分布中学习准确的分位数估计，捕捉每对用户-视频的潜在观看时间的全谱。

## 3.4 推理策略

一旦我们训练了CQE模型来估计观看时间分布的多个分位数，我们就可以采用不同的推理策略。我们提出了三种主要方法：保守估计、动态分位数组合和条件期望。每种策略都提供了不同的优势，并适用于特定的推荐场景。

### 3.4.1 保守估计

在用户满意度至关重要且高估成本较高的环境中，我们采用保守估计（CSE）策略。这种方法侧重于观看时间分布的下分位数，以确保令人满意的用户体验。

如图1(b)所示，当预期观看时间相似时，我们通过选择具有较高下分位数的视频来优先考虑用户满意度。这种策略有助于降低用户因过于乐观的推荐而失望的风险。

正式地，我们选择一个较低的分位数 $ \tau_{\text{low}} $（例如 $ \tau_{\text{low}} = 0.25 $），并使用其对应的观看时间预测：
\[ \hat{y}_{\text{CSE}} = t_{\tau_{\text{low}}} \]（公式6）
这种策略有助于降低用户因过于乐观的推荐而失望的风险，因为实际观看时间很可能超过这个保守估计。

### 3.4.2 动态分位数组合

为了适应不断变化的用户偏好和内容特征，我们提出了一种动态分位数组合（DQC）策略。这种方法根据上下文因素结合不同分位数的预测。

如图1(c)所示，DQC策略根据用户的流失风险和视频新颖性调整分位数的选择。对于高流失风险用户或新颖视频，它更多地赋予低分位数权重，确保令人满意的体验，对于低流失风险用户或熟悉的视频，则更多地赋予高分位数权重，可能提供更具吸引力的推荐。这种动态方法允许系统根据用户当前状态和内容熟悉度，在安全推荐和可能更具回报的推荐之间进行平衡。

设 $ k \in [0, 1] $ 为上下文依赖的混合参数。我们计算最终预测为：

$$
\hat{y}_{\text{DQC}} = k \cdot t_{\tau_{\text{low}}} + (1 - k) \cdot t_{\tau_{\text{high}}}
$$

...(7)

其中：

- $ t_{\tau_{\text{low}}} $ 和 $ t_{\tau_{\text{high}}} $ 分别代表保守和乐观的分位数预测。

混合参数 $ k $ 可以根据用户风险档案、视频新颖性或平台目标等因素进行调整。例如，对于新用户或新颖内容，我们可能使用较高的 $ k $（倾向于保守估计），对于老用户或熟悉的内容类型，则使用较低的 $ k $。

# 

[https://arxiv.org/pdf/2407.12223](https://arxiv.org/pdf/2407.12223)